<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .log-container {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .log-entry {
            margin-bottom: 10px;
            padding: 5px;
            border-left: 3px solid #007bff;
            background: white;
        }
        .log-entry.error {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        .log-entry.warning {
            border-left-color: #ffc107;
            background: #fffbf0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .refresh-btn:hover {
            background: #0056b3;
        }
        .health-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .health-status.healthy {
            background: #d4edda;
            color: #155724;
        }
        .health-status.warning {
            background: #fff3cd;
            color: #856404;
        }
        .health-status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .activity-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .activity-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .activity-item:last-child {
            border-bottom: none;
        }
        .activity-user {
            font-weight: bold;
            color: #007bff;
        }
        .activity-time {
            color: #666;
            font-size: 0.9em;
        }
        .ticket-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ticket-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .ticket-status.open {
            background: #fff3cd;
            color: #856404;
        }
        .ticket-status.in-progress {
            background: #cce5ff;
            color: #004085;
        }
        .ticket-status.resolved {
            background: #d4edda;
            color: #155724;
        }
        .alert-item {
            padding: 10px;
            border-left: 4px solid #007bff;
            background: white;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .alert-item.critical {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        .alert-item.warning {
            border-left-color: #ffc107;
            background: #fffbf0;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            border-bottom-color: #007bff;
            color: #007bff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error-message {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{{ title }}</h1>
            <button class="refresh-btn" onclick="refreshAll()">Refresh All Data</button>
        </div>

        <!-- Main Statistics Grid -->
        <div class="stats-grid" id="mainStats">
            <!-- Main stats will be loaded here -->
        </div>

        <!-- Tabs for different views -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">Overview</button>
            <button class="tab" onclick="showTab('users')">Users & Activity</button>
            <button class="tab" onclick="showTab('support')">Support Tickets</button>
            <button class="tab" onclick="showTab('system')">System & Logs</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h3>System Health</h3>
                    <div id="systemHealth">
                        <p>Loading...</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Recent Activity</h3>
                    <div class="activity-list" id="recentActivity">
                        <p>Loading...</p>
                    </div>
                </div>
            </div>

            <div class="grid">
                <div class="card">
                    <h3>Weekly Entries</h3>
                    <div id="weeklyEntries">
                        <p>Loading...</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>System Alerts</h3>
                    <div id="systemAlerts">
                        <p>Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h3>User Statistics</h3>
                    <div id="userStats">
                        <p>Loading...</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Most Active Users</h3>
                    <div id="mostActiveUsers">
                        <p>Loading...</p>
                    </div>
                </div>
            </div>

            <div class="grid">
                <div class="card">
                    <h3>Last 10 Logins</h3>
                    <div class="activity-list" id="lastLogins">
                        <p>Loading...</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Role Distribution</h3>
                    <div id="roleDistribution">
                        <p>Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Support Tab -->
        <div id="support" class="tab-content">
            <div class="card">
                <h3>Support Tickets</h3>
                <div id="supportTickets">
                    <p>Loading...</p>
                </div>
            </div>
        </div>

        <!-- System Tab -->
        <div id="system" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h3>Recent Support Errors</h3>
                    <div class="log-container" id="errorLogs">
                        <p>Loading...</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Data Access Audit Log</h3>
                    <div class="log-container" id="auditLogs">
                        <p>Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'overview';

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            currentTab = tabName;
            
            // Load data for the selected tab
            if (tabName === 'overview') {
                loadOverviewData();
            } else if (tabName === 'users') {
                loadUsersData();
            } else if (tabName === 'support') {
                loadSupportData();
            } else if (tabName === 'system') {
                loadSystemData();
            }
        }

        function refreshAll() {
            loadMainStats();
            loadSystemHealth();
            loadUsersData();
            loadSupportData();
            loadSystemData();
        }

        function loadMainStats() {
            fetch('/support/api/dashboard-stats/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('mainStats');
                    container.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-number">${data.users.total}</div>
                            <div class="stat-label">Total Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.users.active}</div>
                            <div class="stat-label">Active Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.users.new_this_week}</div>
                            <div class="stat-label">New This Week</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.entries.total_entries_week}</div>
                            <div class="stat-label">Entries This Week</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.support.open_tickets}</div>
                            <div class="stat-label">Open Tickets</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.support.critical_alerts}</div>
                            <div class="stat-label">Critical Alerts</div>
                        </div>
                    `;
                })
                .catch(error => {
                    document.getElementById('mainStats').innerHTML = `<div class="error-message">Error loading main stats: ${error.message}</div>`;
                });
        }

        function loadOverviewData() {
            loadSystemHealth();
            loadRecentActivity();
            loadWeeklyEntries();
            loadSystemAlerts();
        }

        function loadUsersData() {
            loadUserStats();
            loadMostActiveUsers();
            loadLastLogins();
            loadRoleDistribution();
        }

        function loadSupportData() {
            loadSupportTickets();
        }

        function loadSystemData() {
            loadErrorLogs();
            loadAuditLogs();
        }

        function loadSystemHealth() {
            fetch('/support/api/system-health/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('systemHealth');
                    container.innerHTML = `
                        <p><strong>Database:</strong> <span class="health-status ${data.database}">${data.database}</span></p>
                        <p><strong>Logs:</strong> <span class="health-status ${data.logs}">${data.logs}</span></p>
                        <p><strong>Permissions:</strong> <span class="health-status ${data.permissions}">${data.permissions}</span></p>
                        <p><small>Last checked: ${new Date(data.last_check).toLocaleString()}</small></p>
                    `;
                })
                .catch(error => {
                    document.getElementById('systemHealth').innerHTML = `<div class="error-message">Error loading system health: ${error.message}</div>`;
                });
        }

        function loadRecentActivity() {
            fetch('/support/api/dashboard-stats/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('recentActivity');
                    if (data.activities.recent_activities && data.activities.recent_activities.length > 0) {
                        container.innerHTML = data.activities.recent_activities.slice(0, 10).map(activity => `
                            <div class="activity-item">
                                <div>
                                    <div class="activity-user">${activity.user}</div>
                                    <div>${activity.description}</div>
                                </div>
                                <div class="activity-time">${new Date(activity.timestamp).toLocaleString()}</div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p>No recent activity found.</p>';
                    }
                })
                .catch(error => {
                    container.innerHTML = `<div class="error-message">Error loading recent activity: ${error.message}</div>`;
                });
        }

        function loadWeeklyEntries() {
            fetch('/support/api/dashboard-stats/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('weeklyEntries');
                    container.innerHTML = `
                        <p><strong>PD Entries:</strong> ${data.entries.pd_entries_week}</p>
                        <p><strong>Supervision Entries:</strong> ${data.entries.supervision_entries_week}</p>
                        <p><strong>Section A Entries:</strong> ${data.entries.section_a_entries_week}</p>
                        <p><strong>Total:</strong> ${data.entries.total_entries_week}</p>
                    `;
                })
                .catch(error => {
                    container.innerHTML = `<div class="error-message">Error loading weekly entries: ${error.message}</div>`;
                });
        }

        function loadSystemAlerts() {
            fetch('/support/api/system-alerts/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('systemAlerts');
                    if (data.alerts && data.alerts.length > 0) {
                        container.innerHTML = data.alerts.slice(0, 5).map(alert => `
                            <div class="alert-item ${alert.severity.toLowerCase()}">
                                <strong>${alert.title}</strong><br>
                                <small>${alert.description}</small><br>
                                <small>${new Date(alert.created_at).toLocaleString()}</small>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p>No active alerts.</p>';
                    }
                })
                .catch(error => {
                    container.innerHTML = `<div class="error-message">Error loading system alerts: ${error.message}</div>`;
                });
        }

        function loadUserStats() {
            fetch('/support/api/dashboard-stats/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('userStats');
                    container.innerHTML = `
                        <p><strong>Total Users:</strong> ${data.users.total}</p>
                        <p><strong>Active Users:</strong> ${data.users.active}</p>
                        <p><strong>New This Week:</strong> ${data.users.new_this_week}</p>
                        <p><strong>New This Month:</strong> ${data.users.new_this_month}</p>
                        <p><strong>Recent Logins:</strong> ${data.users.recent_logins}</p>
                    `;
                })
                .catch(error => {
                    document.getElementById('userStats').innerHTML = `<div class="error-message">Error loading user stats: ${error.message}</div>`;
                });
        }

        function loadMostActiveUsers() {
            fetch('/support/api/dashboard-stats/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('mostActiveUsers');
                    if (data.activities.most_active_users && data.activities.most_active_users.length > 0) {
                        container.innerHTML = data.activities.most_active_users.map(user => `
                            <div class="activity-item">
                                <div>
                                    <div class="activity-user">${user.user__first_name} ${user.user__last_name}</div>
                                    <div>${user.user__email}</div>
                                </div>
                                <div class="activity-time">${user.activity_count} activities</div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p>No active users found.</p>';
                    }
                })
                .catch(error => {
                    container.innerHTML = `<div class="error-message">Error loading active users: ${error.message}</div>`;
                });
        }

        function loadLastLogins() {
            fetch('/support/api/dashboard-stats/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('lastLogins');
                    if (data.activities.last_10_logins && data.activities.last_10_logins.length > 0) {
                        container.innerHTML = data.activities.last_10_logins.map(login => `
                            <div class="activity-item">
                                <div>
                                    <div class="activity-user">${login.user}</div>
                                    <div>${login.email}</div>
                                </div>
                                <div class="activity-time">${new Date(login.timestamp).toLocaleString()}</div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p>No recent logins found.</p>';
                    }
                })
                .catch(error => {
                    container.innerHTML = `<div class="error-message">Error loading last logins: ${error.message}</div>`;
                });
        }

        function loadRoleDistribution() {
            fetch('/support/api/dashboard-stats/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('roleDistribution');
                    if (data.users.role_distribution && data.users.role_distribution.length > 0) {
                        container.innerHTML = data.users.role_distribution.map(role => `
                            <div class="activity-item">
                                <div class="activity-user">${role.role}</div>
                                <div class="activity-time">${role.count} users</div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p>No role data available.</p>';
                    }
                })
                .catch(error => {
                    container.innerHTML = `<div class="error-message">Error loading role distribution: ${error.message}</div>`;
                });
        }

        function loadSupportTickets() {
            fetch('/support/api/support-tickets/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('supportTickets');
                    if (data.tickets && data.tickets.length > 0) {
                        container.innerHTML = data.tickets.map(ticket => `
                            <div class="ticket-item">
                                <div>
                                    <div><strong>#${ticket.id} - ${ticket.subject}</strong></div>
                                    <div>${ticket.user} (${ticket.user_email})</div>
                                    <div>Assigned to: ${ticket.assigned_to || 'Unassigned'}</div>
                                </div>
                                <div>
                                    <div class="ticket-status ${ticket.status.toLowerCase().replace('_', '-')}">${ticket.status}</div>
                                    <div class="activity-time">${new Date(ticket.created_at).toLocaleString()}</div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p>No support tickets found.</p>';
                    }
                })
                .catch(error => {
                    container.innerHTML = `<div class="error-message">Error loading support tickets: ${error.message}</div>`;
                });
        }

        function loadErrorLogs() {
            fetch('/support/api/error-logs/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('errorLogs');
                    if (data.logs && data.logs.length > 0) {
                        container.innerHTML = data.logs.map(log => `
                            <div class="log-entry error">
                                <strong>${log.timestamp}</strong><br>
                                ${log.content}
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p>No recent errors found.</p>';
                    }
                })
                .catch(error => {
                    container.innerHTML = `<div class="error-message">Error loading error logs: ${error.message}</div>`;
                });
        }

        function loadAuditLogs() {
            fetch('/support/api/audit-logs/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('auditLogs');
                    if (data.logs && data.logs.length > 0) {
                        container.innerHTML = data.logs.map(log => `
                            <div class="log-entry">
                                <strong>${log.timestamp}</strong><br>
                                ${log.content}
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p>No recent audit logs found.</p>';
                    }
                })
                .catch(error => {
                    container.innerHTML = `<div class="error-message">Error loading audit logs: ${error.message}</div>`;
                });
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadMainStats();
            loadOverviewData();
        });

        // Auto-refresh every 30 seconds
        setInterval(refreshAll, 30000);
    </script>
</body>
</html>



