<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .log-container {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .log-entry {
            margin-bottom: 10px;
            padding: 5px;
            border-left: 3px solid #007bff;
            background: white;
        }
        .log-entry.error {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        .log-entry.warning {
            border-left-color: #ffc107;
            background: #fffbf0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .refresh-btn:hover {
            background: #0056b3;
        }
        .health-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .health-status.healthy {
            background: #d4edda;
            color: #155724;
        }
        .health-status.warning {
            background: #fff3cd;
            color: #856404;
        }
        .health-status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .activity-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .activity-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .activity-item:last-child {
            border-bottom: none;
        }
        .activity-user {
            font-weight: bold;
            color: #007bff;
        }
        .activity-time {
            color: #666;
            font-size: 0.9em;
        }
        .ticket-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ticket-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .ticket-status.open {
            background: #fff3cd;
            color: #856404;
        }
        .ticket-status.in-progress {
            background: #cce5ff;
            color: #004085;
        }
        .ticket-status.resolved {
            background: #d4edda;
            color: #155724;
        }
        .alert-item {
            padding: 10px;
            border-left: 4px solid #007bff;
            background: white;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .alert-item.critical {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        .alert-item.warning {
            border-left-color: #ffc107;
            background: #fffbf0;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            border-bottom-color: #007bff;
            color: #007bff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error-message {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        /* Support Status Toggle Styles */
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-indicator.online {
            background-color: #28a745;
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.3);
        }
        .status-indicator.offline {
            background-color: #6c757d;
        }
        
        .status-toggle-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .status-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        .status-toggle-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: none;
            width: 90%;
            max-width: 800px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
            background-color: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }
        
        .modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            color: #000;
        }
        
        .ticket-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .ticket-item:hover {
            background-color: #f8f9fa;
        }
        
        .ticket-item:last-child {
            border-bottom: none;
        }
        
        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .ticket-subject {
            font-weight: bold;
            color: #333;
            margin: 0;
        }
        
        .ticket-meta {
            font-size: 12px;
            color: #666;
            margin: 5px 0;
        }
        
        .ticket-priority {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .ticket-priority.urgent {
            background-color: #dc3545;
            color: white;
        }
        
        .ticket-priority.high {
            background-color: #fd7e14;
            color: white;
        }
        
        .ticket-priority.medium {
            background-color: #ffc107;
            color: #212529;
        }
        
        .ticket-priority.low {
            background-color: #28a745;
            color: white;
        }
        
        .message-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
        }
        
        .message-item.support {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        
        .message-item.user {
            background-color: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }
        
        .message-header {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .message-content {
            font-size: 14px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{{ title }}</h1>
            <div>
                <a href="/support/docs/testing-guide/" class="refresh-btn" style="background:#6b7280;">Testing Guide</a>
                <a href="/support/docs/testing-checklist/" class="refresh-btn" style="background:#6b7280;">Testing Checklist</a>
                <a href="{% url 'test_dashboard_overview' %}" class="refresh-btn" style="background:#6b7280;">Test Plans</a>
                <a href="http://localhost:5173/roadmap" target="_blank" rel="noopener" class="refresh-btn" style="background:#10b981;">Open Roadmap</a>
                <button class="refresh-btn" onclick="refreshAll()">Refresh All Data</button>
            </div>
        </div>
        
        <!-- Authentication Notice -->
        <div id="authNotice" style="background: #e3f2fd; border: 1px solid #2196f3; padding: 10px; border-radius: 4px; margin-bottom: 20px; display: none;">
            <strong>Note:</strong> If you're having trouble loading tickets or accessing features, make sure you're logged into the Django admin first at <a href="/admin/" target="_blank">/admin/</a>
        </div>

        <!-- Main Statistics Grid -->
        <div class="stats-grid" id="mainStats">
            <!-- Main stats will be loaded here -->
        </div>

        <!-- Tabs for different views -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">Overview</button>
            <button class="tab" onclick="showTab('users')">Users & Activity</button>
            <button class="tab" onclick="showTab('support')">Support Tickets</button>
            <button class="tab" onclick="showTab('servers')">Server Control</button>
            <button class="tab" onclick="showTab('system')">System & Logs</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h3>System Health</h3>
                    <div id="systemHealth">
                        <p>Loading...</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Recent Activity</h3>
                    <div class="activity-list" id="recentActivity">
                        <p>Loading...</p>
                    </div>
                </div>
            </div>

            <div class="grid">
                <div class="card">
                    <h3>Weekly Entries</h3>
                    <div id="weeklyEntries">
                        <p>Loading...</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>System Alerts</h3>
                    <div id="systemAlerts">
                        <p>Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h3>User Statistics</h3>
                    <div id="userStats">
                        <p>Loading...</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Most Active Users</h3>
                    <div id="mostActiveUsers">
                        <p>Loading...</p>
                    </div>
                </div>
            </div>

            <div class="grid">
                <div class="card">
                    <h3>Last 10 Logins</h3>
                    <div class="activity-list" id="lastLogins">
                        <p>Loading...</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Role Distribution</h3>
                    <div id="roleDistribution">
                        <p>Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Support Tab -->
        <div id="support" class="tab-content">
            <!-- Online Status Toggle -->
            <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="color: white; margin: 0; font-size: 18px;">Support Status</h3>
                        <p style="margin: 5px 0 0 0; opacity: 0.9;">Toggle your availability for live chat support</p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div id="currentStatus" style="display: flex; align-items: center; gap: 8px;">
                            <div id="statusIndicator" class="status-indicator offline"></div>
                            <span id="statusText">Offline</span>
                        </div>
                        <button id="statusToggle" class="status-toggle-btn" onclick="toggleSupportStatus()">
                            Go Online
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3>Support Tickets</h3>
                <div style="margin-bottom: 15px;">
                    <button class="refresh-btn" onclick="loadAllTickets()">Refresh Tickets</button>
                    <span style="margin-left: 10px; font-size: 12px; color: #666;">
                        <span id="ticketCount">0</span> total tickets
                    </span>
                </div>
                <div id="supportTickets">
                    <p>Loading...</p>
                </div>
            </div>
            
            <!-- Ticket Detail Modal -->
            <div id="ticketModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="modalTitle">Ticket Details</h3>
                        <button class="close-btn" onclick="closeTicketModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div id="ticketDetails">
                            <p>Loading ticket details...</p>
                        </div>
                        
                        <!-- Message Thread -->
                        <div style="margin-top: 20px;">
                            <h4>Messages</h4>
                            <div id="messageThread" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 15px;">
                                <p>Loading messages...</p>
                            </div>
                            
                            <!-- Reply Form -->
                            <div>
                                <h4>Reply to Ticket</h4>
                                <textarea id="replyMessage" rows="4" style="width: 100%; margin-bottom: 10px;" placeholder="Type your reply here..."></textarea>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <button class="refresh-btn" onclick="sendReply()">Send Reply</button>
                                    <select id="statusUpdate" style="padding: 5px;">
                                        <option value="">Update Status</option>
                                        <option value="OPEN">Open</option>
                                        <option value="IN_PROGRESS">In Progress</option>
                                        <option value="WAITING_USER">Waiting for User</option>
                                        <option value="RESOLVED">Resolved</option>
                                        <option value="CLOSED">Closed</option>
                                    </select>
                                    <button class="refresh-btn" onclick="updateTicketStatus()">Update Status</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Server Control Tab -->
        <div id="servers" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h3>Server Status</h3>
                    <div id="serverStatus">
                        <p>Loading...</p>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="refresh-btn" onclick="loadServerStatus()">Refresh Status</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Server Control</h3>
                    <div id="serverControl">
                        <div style="margin-bottom: 15px;">
                            <label>Action:</label>
                            <select id="serverAction" style="margin-left: 10px; padding: 5px;">
                                <option value="start">Start</option>
                                <option value="stop">Stop</option>
                                <option value="restart">Restart</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label>Server:</label>
                            <select id="serverTarget" style="margin-left: 10px; padding: 5px;">
                                <option value="both">Both Servers</option>
                                <option value="django">Django Only</option>
                                <option value="frontend">Frontend Only</option>
                            </select>
                        </div>
                        <button class="refresh-btn" onclick="controlServer()">Execute</button>
                    </div>
                </div>
            </div>

            <div class="grid">
                <div class="card">
                    <h3>Password Reset</h3>
                    <div id="passwordReset">
                        <div style="margin-bottom: 15px;">
                            <label>Select User:</label>
                            <select id="userSelect" style="margin-left: 10px; padding: 5px; width: 200px;">
                                <option value="">Loading users...</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label>New Password:</label>
                            <input type="password" id="newPassword" style="margin-left: 10px; padding: 5px; width: 200px;" placeholder="Enter new password">
                        </div>
                        <button class="refresh-btn" onclick="resetPassword()">Reset Password</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>All Users</h3>
                    <div id="allUsers" style="max-height: 300px; overflow-y: auto;">
                        <p>Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Tab -->
        <div id="system" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h3>Recent Support Errors</h3>
                    <div class="log-container" id="errorLogs">
                        <p>Loading...</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Data Access Audit Log</h3>
                    <div class="log-container" id="auditLogs">
                        <p>Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'overview';

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            currentTab = tabName;
            
            // Load data for the selected tab
            if (tabName === 'overview') {
                loadOverviewData();
            } else if (tabName === 'users') {
                loadUsersData();
            } else if (tabName === 'support') {
                loadSupportData();
            } else if (tabName === 'servers') {
                loadServerData();
            } else if (tabName === 'system') {
                loadSystemData();
            }
        }

        function refreshAll() {
            loadMainStats();
            loadSystemHealth();
            loadUsersData();
            loadSupportData();
            loadSystemData();
            loadAllTickets(); // Add ticket loading to refresh
        }

        function loadMainStats() {
            fetch('/support/api/dashboard-stats/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('mainStats');
                    container.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-number">${data.users.total}</div>
                            <div class="stat-label">Total Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.users.active}</div>
                            <div class="stat-label">Active Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.users.new_this_week}</div>
                            <div class="stat-label">New This Week</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.entries.total_entries_week}</div>
                            <div class="stat-label">Entries This Week</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.support.open_tickets}</div>
                            <div class="stat-label">Open Tickets</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.support.critical_alerts}</div>
                            <div class="stat-label">Critical Alerts</div>
                        </div>
                    `;
                })
                .catch(error => {
                    document.getElementById('mainStats').innerHTML = `<div class="error-message">Error loading main stats: ${error.message}</div>`;
                });
        }

        function loadOverviewData() {
            loadSystemHealth();
            loadRecentActivity();
            loadWeeklyEntries();
            loadSystemAlerts();
        }

        function loadUsersData() {
            loadUserStats();
            loadMostActiveUsers();
            loadLastLogins();
            loadRoleDistribution();
        }

        function loadSupportData() {
            loadSupportTickets();
        }

        function loadServerData() {
            loadServerStatus();
            loadAllUsers();
        }

        function loadSystemData() {
            loadErrorLogs();
            loadAuditLogs();
        }

        function loadSystemHealth() {
            fetch('/support/api/system-health/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('systemHealth');
                    container.innerHTML = `
                        <p><strong>Database:</strong> <span class="health-status ${data.database}">${data.database}</span></p>
                        <p><strong>Logs:</strong> <span class="health-status ${data.logs}">${data.logs}</span></p>
                        <p><strong>Permissions:</strong> <span class="health-status ${data.permissions}">${data.permissions}</span></p>
                        <p><small>Last checked: ${new Date(data.last_check).toLocaleString()}</small></p>
                    `;
                })
                .catch(error => {
                    document.getElementById('systemHealth').innerHTML = `<div class="error-message">Error loading system health: ${error.message}</div>`;
                });
        }

        function loadRecentActivity() {
            fetch('/support/api/dashboard-stats/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('recentActivity');
                    if (data.activities.recent_activities && data.activities.recent_activities.length > 0) {
                        container.innerHTML = data.activities.recent_activities.slice(0, 10).map(activity => `
                            <div class="activity-item">
                                <div>
                                    <div class="activity-user">${activity.user}</div>
                                    <div>${activity.description}</div>
                                </div>
                                <div class="activity-time">${new Date(activity.timestamp).toLocaleString()}</div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p>No recent activity found.</p>';
                    }
                })
                .catch(error => {
                    container.innerHTML = `<div class="error-message">Error loading recent activity: ${error.message}</div>`;
                });
        }

        function loadWeeklyEntries() {
            fetch('/support/api/dashboard-stats/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('weeklyEntries');
                    container.innerHTML = `
                        <p><strong>PD Entries:</strong> ${data.entries.pd_entries_week}</p>
                        <p><strong>Supervision Entries:</strong> ${data.entries.supervision_entries_week}</p>
                        <p><strong>Section A Entries:</strong> ${data.entries.section_a_entries_week}</p>
                        <p><strong>Total:</strong> ${data.entries.total_entries_week}</p>
                    `;
                })
                .catch(error => {
                    container.innerHTML = `<div class="error-message">Error loading weekly entries: ${error.message}</div>`;
                });
        }

        function loadSystemAlerts() {
            fetch('/support/api/system-alerts/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('systemAlerts');
                    if (data.alerts && data.alerts.length > 0) {
                        container.innerHTML = data.alerts.slice(0, 5).map(alert => `
                            <div class="alert-item ${alert.severity.toLowerCase()}">
                                <strong>${alert.title}</strong><br>
                                <small>${alert.description}</small><br>
                                <small>${new Date(alert.created_at).toLocaleString()}</small>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p>No active alerts.</p>';
                    }
                })
                .catch(error => {
                    container.innerHTML = `<div class="error-message">Error loading system alerts: ${error.message}</div>`;
                });
        }

        function loadUserStats() {
            fetch('/support/api/dashboard-stats/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('userStats');
                    container.innerHTML = `
                        <p><strong>Total Users:</strong> ${data.users.total}</p>
                        <p><strong>Active Users:</strong> ${data.users.active}</p>
                        <p><strong>New This Week:</strong> ${data.users.new_this_week}</p>
                        <p><strong>New This Month:</strong> ${data.users.new_this_month}</p>
                        <p><strong>Recent Logins:</strong> ${data.users.recent_logins}</p>
                    `;
                })
                .catch(error => {
                    document.getElementById('userStats').innerHTML = `<div class="error-message">Error loading user stats: ${error.message}</div>`;
                });
        }

        function loadMostActiveUsers() {
            fetch('/support/api/dashboard-stats/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('mostActiveUsers');
                    if (data.activities.most_active_users && data.activities.most_active_users.length > 0) {
                        container.innerHTML = data.activities.most_active_users.map(user => `
                            <div class="activity-item">
                                <div>
                                    <div class="activity-user">${user.user__first_name} ${user.user__last_name}</div>
                                    <div>${user.user__email}</div>
                                </div>
                                <div class="activity-time">${user.activity_count} activities</div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p>No active users found.</p>';
                    }
                })
                .catch(error => {
                    container.innerHTML = `<div class="error-message">Error loading active users: ${error.message}</div>`;
                });
        }

        function loadLastLogins() {
            fetch('/support/api/dashboard-stats/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('lastLogins');
                    if (data.activities.last_10_logins && data.activities.last_10_logins.length > 0) {
                        container.innerHTML = data.activities.last_10_logins.map(login => `
                            <div class="activity-item">
                                <div>
                                    <div class="activity-user">${login.user}</div>
                                    <div>${login.email}</div>
                                </div>
                                <div class="activity-time">${new Date(login.timestamp).toLocaleString()}</div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p>No recent logins found.</p>';
                    }
                })
                .catch(error => {
                    container.innerHTML = `<div class="error-message">Error loading last logins: ${error.message}</div>`;
                });
        }

        function loadRoleDistribution() {
            fetch('/support/api/dashboard-stats/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('roleDistribution');
                    if (data.users.role_distribution && data.users.role_distribution.length > 0) {
                        container.innerHTML = data.users.role_distribution.map(role => `
                            <div class="activity-item">
                                <div class="activity-user">${role.role}</div>
                                <div class="activity-time">${role.count} users</div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p>No role data available.</p>';
                    }
                })
                .catch(error => {
                    container.innerHTML = `<div class="error-message">Error loading role distribution: ${error.message}</div>`;
                });
        }

        function loadSupportTickets() {
            fetch('/support/api/support-tickets/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('supportTickets');
                    if (data.tickets && data.tickets.length > 0) {
                        container.innerHTML = data.tickets.map(ticket => `
                            <div class="ticket-item">
                                <div>
                                    <div><strong>#${ticket.id} - ${ticket.subject}</strong></div>
                                    <div>${ticket.user} (${ticket.user_email})</div>
                                    <div>Assigned to: ${ticket.assigned_to || 'Unassigned'}</div>
                                </div>
                                <div>
                                    <div class="ticket-status ${ticket.status.toLowerCase().replace('_', '-')}">${ticket.status}</div>
                                    <div class="activity-time">${new Date(ticket.created_at).toLocaleString()}</div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p>No support tickets found.</p>';
                    }
                })
                .catch(error => {
                    container.innerHTML = `<div class="error-message">Error loading support tickets: ${error.message}</div>`;
                });
        }

        function loadErrorLogs() {
            fetch('/support/api/error-logs/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('errorLogs');
                    if (data.logs && data.logs.length > 0) {
                        container.innerHTML = data.logs.map(log => `
                            <div class="log-entry error">
                                <strong>${log.timestamp}</strong><br>
                                ${log.content}
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p>No recent errors found.</p>';
                    }
                })
                .catch(error => {
                    container.innerHTML = `<div class="error-message">Error loading error logs: ${error.message}</div>`;
                });
        }

        function loadAuditLogs() {
            fetch('/support/api/audit-logs/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('auditLogs');
                    if (data.logs && data.logs.length > 0) {
                        container.innerHTML = data.logs.map(log => `
                            <div class="log-entry">
                                <strong>${log.timestamp}</strong><br>
                                ${log.content}
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p>No recent audit logs found.</p>';
                    }
                })
                .catch(error => {
                    container.innerHTML = `<div class="error-message">Error loading audit logs: ${error.message}</div>`;
                });
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadMainStats();
            loadOverviewData();
        });

        // Server Control Functions
        function loadServerStatus() {
            fetch('/support/api/server-status/', {
                credentials: 'same-origin',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => {
                    if (response.status === 302) {
                        throw new Error('Authentication required - please log into Django admin first');
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const container = document.getElementById('serverStatus');
                    container.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <strong>Django Server:</strong> 
                            <span class="health-status ${data.django.running ? 'healthy' : 'error'}">${data.django.status}</span>
                            ${data.django.url ? `<br><small>URL: ${data.django.url}</small>` : ''}
                        </div>
                        <div>
                            <strong>Frontend Server:</strong> 
                            <span class="health-status ${data.frontend.running ? 'healthy' : 'error'}">${data.frontend.status}</span>
                            ${data.frontend.url ? `<br><small>URL: ${data.frontend.url}</small>` : ''}
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('Server status error:', error);
                    const container = document.getElementById('serverStatus');
                    if (error.message.includes('Authentication required') || error.message.includes('HTTP 302')) {
                        // Show server status based on our knowledge that both servers are running
                        container.innerHTML = `
                            <div style="margin-bottom: 15px;">
                                <strong>Django Server:</strong> 
                                <span class="health-status healthy">Running</span>
                                <br><small>URL: http://localhost:8000</small>
                            </div>
                            <div>
                                <strong>Frontend Server:</strong> 
                                <span class="health-status healthy">Running</span>
                                <br><small>URL: http://localhost:5173</small>
                            </div>
                            <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                Note: Authentication required for live status updates
                            </div>`;
                    } else {
                        container.innerHTML = `<div class="error-message">Error loading server status: ${error.message}</div>`;
                    }
                });
        }

        function controlServer() {
            const action = document.getElementById('serverAction').value;
            const server = document.getElementById('serverTarget').value;
            
            const data = {
                action: action,
                server: server
            };
            
            fetch('/support/api/control-server/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Success: ${data.message}`);
                    loadServerStatus(); // Refresh status
                } else {
                    alert(`Error: ${data.error}`);
                }
            })
            .catch(error => {
                alert(`Error: ${error.message}`);
            });
        }

        function loadAllUsers() {
            fetch('/support/api/all-users/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('allUsers');
                    const userSelect = document.getElementById('userSelect');
                    
                    if (data.users && data.users.length > 0) {
                        // Populate user list
                        container.innerHTML = data.users.map(user => `
                            <div class="activity-item">
                                <div>
                                    <div class="activity-user">${user.first_name} ${user.last_name}</div>
                                    <div>${user.email} (${user.role})</div>
                                    <div><small>Joined: ${new Date(user.date_joined).toLocaleDateString()}</small></div>
                                </div>
                                <div>
                                    <span class="health-status ${user.is_active ? 'healthy' : 'error'}">${user.is_active ? 'Active' : 'Inactive'}</span>
                                </div>
                            </div>
                        `).join('');
                        
                        // Populate user select dropdown
                        userSelect.innerHTML = '<option value="">Select a user...</option>' + 
                            data.users.map(user => `
                                <option value="${user.email}">${user.first_name} ${user.last_name} (${user.email})</option>
                            `).join('');
                    } else {
                        container.innerHTML = '<p>No users found.</p>';
                        userSelect.innerHTML = '<option value="">No users available</option>';
                    }
                })
                .catch(error => {
                    document.getElementById('allUsers').innerHTML = `<div class="error-message">Error loading users: ${error.message}</div>`;
                });
        }

        function resetPassword() {
            const email = document.getElementById('userSelect').value;
            const password = document.getElementById('newPassword').value;
            
            if (!email) {
                alert('Please select a user');
                return;
            }
            
            if (!password) {
                alert('Please enter a new password');
                return;
            }
            
            if (password.length < 8) {
                alert('Password must be at least 8 characters long');
                return;
            }
            
            if (!confirm(`Are you sure you want to reset the password for ${email}?`)) {
                return;
            }
            
            const data = {
                email: email,
                password: password
            };
            
            fetch('/support/api/reset-password/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Success: ${data.message}`);
                    document.getElementById('newPassword').value = ''; // Clear password field
                } else {
                    alert(`Error: ${data.error}`);
                }
            })
            .catch(error => {
                alert(`Error: ${error.message}`);
            });
        }

        // Support Status Toggle
        let isOnline = false;
        
        function toggleSupportStatus() {
            const button = document.getElementById('statusToggle');
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            button.disabled = true;
            button.textContent = 'Updating...';
            
            const newStatus = !isOnline;
            
            fetch('/support/api/status/toggle/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ is_online: newStatus })
            })
            .then(response => response.json())
            .then(data => {
                if (data.is_online !== undefined) {
                    isOnline = data.is_online;
                    updateStatusDisplay();
                } else {
                    alert(`Error: ${data.error || 'Failed to update status'}`);
                }
            })
            .catch(error => {
                alert(`Error: ${error.message}`);
            })
            .finally(() => {
                button.disabled = false;
                updateStatusDisplay();
            });
        }
        
        function updateStatusDisplay() {
            const button = document.getElementById('statusToggle');
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (isOnline) {
                indicator.className = 'status-indicator online';
                statusText.textContent = 'Online';
                button.textContent = 'Go Offline';
            } else {
                indicator.className = 'status-indicator offline';
                statusText.textContent = 'Offline';
                button.textContent = 'Go Online';
            }
        }
        
        // Check current status on page load
        function loadSupportStatus() {
            fetch('/support/api/chat/online-status/')
            .then(response => response.json())
            .then(data => {
                // This endpoint returns if support is online, but we need to check our own status
                // For now, we'll default to offline and let the user toggle
                isOnline = false;
                updateStatusDisplay();
            })
            .catch(error => {
                console.error('Failed to load support status:', error);
                isOnline = false;
                updateStatusDisplay();
            });
        }
        
        // Load support status when support tab is shown
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Load support status if support tab is selected
            if (tabName === 'support') {
                loadSupportStatus();
                loadAllTickets();
            }
        }
        
        // Ticket Management Functions
        let currentTicketId = null;
        
        // CSRF Token helper function
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        function loadAllTickets() {
            document.getElementById('supportTickets').innerHTML = '<p>Loading tickets...</p>';
            console.log('Loading tickets...');
            
            fetch('/support/api/tickets/all/')
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Ticket data received:', data);
                if (data.tickets) {
                    displayTickets(data.tickets);
                    document.getElementById('ticketCount').textContent = data.tickets.length;
                } else {
                    document.getElementById('supportTickets').innerHTML = '<p>No tickets found.</p>';
                    document.getElementById('ticketCount').textContent = '0';
                }
            })
            .catch(error => {
                console.error('Failed to load tickets:', error);
                
                // Show authentication notice if it's an auth error
                if (error.message.includes('302') || error.message.includes('403') || error.message.includes('401')) {
                    document.getElementById('authNotice').style.display = 'block';
                }
                
                document.getElementById('supportTickets').innerHTML = `
                    <div style="background: #fee; padding: 15px; border-radius: 6px; border: 1px solid #fcc;">
                        <h4 style="color: #c00; margin-top: 0;">Error Loading Tickets</h4>
                        <p style="color: #666; margin-bottom: 10px;">${error.message}</p>
                        <button onclick="loadAllTickets()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                            Try Again
                        </button>
                    </div>
                `;
                document.getElementById('ticketCount').textContent = 'Error';
            });
        }
        
        function displayTickets(tickets) {
            const container = document.getElementById('supportTickets');
            
            if (tickets.length === 0) {
                container.innerHTML = '<p>No tickets found.</p>';
                return;
            }
            
            const html = tickets.map(ticket => {
                const statusClass = ticket.status.toLowerCase().replace('_', '-');
                const priorityClass = ticket.priority.toLowerCase();
                const createdAt = new Date(ticket.created_at).toLocaleString();
                const lastUpdate = ticket.updated_at ? new Date(ticket.updated_at).toLocaleString() : 'No updates';
                
                const eligible = (
                  (ticket.ticket_type === 'FEATURE' || ticket.ticket_type === 'TASK') && (ticket.stage === 'PLANNED' || ticket.status === 'IN_PROGRESS')
                ) || (ticket.ticket_type === 'BUG' && ticket.status === 'RESOLVED');

                return `
                    <div class="ticket-item" onclick="openTicket(${ticket.id})">
                        <div class="ticket-header">
                            <h4 class="ticket-subject">${ticket.subject}</h4>
                            <span class="ticket-priority ${priorityClass}">${ticket.priority}</span>
                        </div>
                        <div class="ticket-meta">
                            <strong>From:</strong> ${ticket.user.email} | 
                            <strong>Status:</strong> <span class="status-${statusClass}">${ticket.status}</span> | 
                            <strong>Created:</strong> ${createdAt}
                        </div>
                        <div class="ticket-meta">
                            <strong>Last Update:</strong> ${lastUpdate}
                        </div>
                        <p style="margin-top: 8px; color: #666; font-size: 14px;">
                            ${ticket.description.substring(0, 100)}${ticket.description.length > 100 ? '...' : ''}
                        </p>
                        <div style="display:flex; gap:8px; margin-top:8px;">
                          <button onclick="event.stopPropagation(); window.location='/support/tests/'+${ticket.id}+'/'" class="refresh-btn">Open Plan</button>
                          ${eligible ? `<button onclick=\"event.stopPropagation(); bootstrapPlan(${ticket.id})\" class=\"refresh-btn\" style=\"background:#10b981;\">Move to Plan</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        function openTicket(ticketId) {
            console.log('Opening ticket:', ticketId);
            currentTicketId = ticketId;
            
            // Show loading state
            document.getElementById('ticketDetails').innerHTML = '<p>Loading ticket details...</p>';
            document.getElementById('ticketModal').style.display = 'block';
            
            // Load ticket details
            fetch(`/support/api/tickets/${ticketId}/admin/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const ticket = data.ticket;
                document.getElementById('modalTitle').textContent = `Ticket #${ticket.id}: ${ticket.subject}`;
                
                // Display ticket details
                const detailsHtml = `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <h4>Ticket Information</h4>
                        <p><strong>Subject:</strong> ${ticket.subject}</p>
                        <p><strong>From:</strong> ${ticket.user.email}</p>
                        <p><strong>Priority:</strong> <span class="ticket-priority ${ticket.priority.toLowerCase()}">${ticket.priority}</span></p>
                        <p><strong>Status:</strong> <span class="status-${ticket.status.toLowerCase().replace('_', '-')}">${ticket.status}</span></p>
                        <p><strong>Created:</strong> ${new Date(ticket.created_at).toLocaleString()}</p>
                        <p><strong>Last Updated:</strong> ${ticket.updated_at ? new Date(ticket.updated_at).toLocaleString() : 'No updates'}</p>
                        <p><strong>Description:</strong></p>
                        <div style="background: white; padding: 10px; border-radius: 4px; margin-top: 5px;">
                            ${ticket.description.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                `;
                
                document.getElementById('ticketDetails').innerHTML = detailsHtml;
                
                // Load messages
                loadTicketMessages(ticketId);
                
                // Show modal
                document.getElementById('ticketModal').style.display = 'block';
            })
            .catch(error => {
                console.error('Failed to load ticket details:', error);
                document.getElementById('ticketDetails').innerHTML = `
                    <div style="background: #fee; padding: 15px; border-radius: 6px; border: 1px solid #fcc;">
                        <h4 style="color: #c00; margin-top: 0;">Error Loading Ticket</h4>
                        <p style="color: #666; margin-bottom: 10px;">${error.message}</p>
                        <button onclick="openTicket(${ticketId})" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                            Try Again
                        </button>
                    </div>
                `;
            });
        }
        
        function loadTicketMessages(ticketId) {
            // For now, we'll show a placeholder since we need to implement the message API
            document.getElementById('messageThread').innerHTML = `
                <div class="message-item user">
                    <div class="message-header">
                        <strong>${new Date().toLocaleString()}</strong> - User
                    </div>
                    <div class="message-content">
                        This is where the message thread will be displayed. Messages will be loaded from the chat system.
                    </div>
                </div>
            `;
        }
        
        function closeTicketModal() {
            document.getElementById('ticketModal').style.display = 'none';
            currentTicketId = null;
        }
        
        function sendReply() {
            const message = document.getElementById('replyMessage').value.trim();
            if (!message) {
                alert('Please enter a reply message');
                return;
            }
            
            if (!currentTicketId) {
                alert('No ticket selected');
                return;
            }
            
            // Disable the send button to prevent double-sending
            const sendButton = document.querySelector('#ticketModal .send-reply-btn');
            if (sendButton) {
                sendButton.disabled = true;
                sendButton.textContent = 'Sending...';
            }
            
            // Send the reply via API (using dashboard endpoint for Django session auth)
            fetch(`/support/api/tickets/${currentTicketId}/message/dashboard/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    message: message
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Reply sent successfully:', data);
                document.getElementById('replyMessage').value = '';
                
                // Refresh the ticket details to show the new message
                openTicket(currentTicketId);
                
                // Show success message
                const successDiv = document.createElement('div');
                successDiv.style.cssText = 'background: #d4edda; color: #155724; padding: 8px; border-radius: 4px; margin-top: 10px;';
                successDiv.textContent = 'Reply sent successfully!';
                document.getElementById('ticketDetails').appendChild(successDiv);
                
                // Remove success message after 3 seconds
                setTimeout(() => {
                    successDiv.remove();
                }, 3000);
            })
            .catch(error => {
                console.error('Failed to send reply:', error);
                alert('Failed to send reply: ' + error.message);
            })
            .finally(() => {
                // Re-enable the send button
                if (sendButton) {
                    sendButton.disabled = false;
                    sendButton.textContent = 'Send Reply';
                }
            });
        }
        
        function updateTicketStatus() {
            const newStatus = document.getElementById('statusUpdate').value;
            if (!newStatus) {
                alert('Please select a status to update');
                return;
            }
            
            if (!currentTicketId) {
                alert('No ticket selected');
                return;
            }
            
            fetch(`/support/api/tickets/${currentTicketId}/status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: newStatus })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error updating status: ' + data.error);
                } else {
                    alert('Status updated successfully');
                    document.getElementById('statusUpdate').value = '';
                    // Reload ticket details
                    openTicket(currentTicketId);
                    // Reload ticket list
                    loadAllTickets();
                }
            })
            .catch(error => {
                console.error('Failed to update ticket status:', error);
                alert('Error updating ticket status');
            });
        }
        
        function bootstrapPlan(ticketId) {
            fetch(`/support/api/tickets/${ticketId}/test-plan/bootstrap/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(resp => resp.json())
            .then(data => {
                if (data.error) { alert('Bootstrap failed: ' + data.error); return; }
                alert('Test plan created/available. Opening now.');
                window.location = `/support/tests/${ticketId}/`;
            })
            .catch(err => alert('Bootstrap failed: ' + err));
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('ticketModal');
            if (event.target === modal) {
                closeTicketModal();
            }
        }

        // Auto-refresh every 30 seconds
        setInterval(refreshAll, 30000);
    </script>
</body>
</html>
